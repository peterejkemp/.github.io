<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>MASTEMR - Piping and dplyr</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link rel="stylesheet" href="../css/mastemr.css">
</head>
<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="index.qmd" class="navbar-brand navbar-brand-logo">
    <img src="../images/KCL_logo.png" alt="" class="navbar-logo"></a>
    <a class="navbar-brand" href="index.qmd">
    <span class="navbar-title">MASTEMR</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/01-Intro_to_quant_methods.html">Sessions</a></li><li class="breadcrumb-item"><a href="../chapters/02-1-Intro_to_analysis_software.html">02 Introduction to R</a></li><li class="breadcrumb-item"><a href="../chapters/02-3-Intro_to_analysis_software.html">Piping and dplyr</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto"><div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Sessions</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/01-Intro_to_quant_methods.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">01 Introduction</span></a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">02 Introduction to R</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/02-1-Intro_to_analysis_software.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/02-2-Intro_to_analysis_software.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Loading packages and exploring data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/02-3-Intro_to_analysis_software.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Piping and dplyr</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/02-4-Intro_to_graphs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Making graphs</span></a>
  </div>
</li>
      </ul>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/03-Descriptive.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">03 Descriptive Statistics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/04-Presentations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">04 Presentations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/05-Introduction_to_PISA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">05 Introduction to PISA</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/06-ChisqPISA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">07 Chi-square tests</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/07-T-testsPISA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">06 T-tests</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/08-Writing_report.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">08 Writing a quantitative report</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/09-Assignment_3_tutorials.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">09 Assignment 3 tutorials</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/10-Correlation_and_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">10 Correlation and regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/11-selecting_statistical_tools.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">11 Selecting statistical tools</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/12-value_of_quant.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">12 The value of quantitative methods</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/QandA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Questions and Answers</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Data sets</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A1-PISA_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">PISA</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A2-DfE_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DfE England</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A3-TIMSS_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">TIMSS, PIRLS and ICILS</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A4-Other_datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Other datasets</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/A5-Self_Study_Tasks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Appendix Self Study Tasks</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li>
<a href="#select" id="toc-select" class="nav-link active" data-scroll-target="#select"><span class="header-section-number">1</span> select</a>
  <ul class="collapse">
<li><a href="#questions" id="toc-questions" class="nav-link" data-scroll-target="#questions"><span class="header-section-number">1.1</span> Questions</a></li>
  </ul>
</li>
  <li>
<a href="#filter" id="toc-filter" class="nav-link" data-scroll-target="#filter"><span class="header-section-number">2</span> filter</a>
  <ul class="collapse">
<li><a href="#questions-1" id="toc-questions-1" class="nav-link" data-scroll-target="#questions-1"><span class="header-section-number">2.1</span> Questions</a></li>
  </ul>
</li>
  <li><a href="#sec-renaming" id="toc-sec-renaming" class="nav-link" data-scroll-target="#sec-renaming"><span class="header-section-number">3</span> renaming columns</a></li>
  <li>
<a href="#group_by-and-summarise" id="toc-group_by-and-summarise" class="nav-link" data-scroll-target="#group_by-and-summarise"><span class="header-section-number">4</span> group_by and summarise</a>
  <ul class="collapse">
<li><a href="#questions-2" id="toc-questions-2" class="nav-link" data-scroll-target="#questions-2"><span class="header-section-number">4.1</span> Questions</a></li>
  </ul>
</li>
  <li><a href="#sec-mutate" id="toc-sec-mutate" class="nav-link" data-scroll-target="#sec-mutate"><span class="header-section-number">5</span> mutate</a></li>
  <li><a href="#arrange" id="toc-arrange" class="nav-link" data-scroll-target="#arrange"><span class="header-section-number">6</span> arrange</a></li>
  <li><a href="#bring-everyting-together" id="toc-bring-everyting-together" class="nav-link" data-scroll-target="#bring-everyting-together"><span class="header-section-number">7</span> Bring everyting together</a></li>
  <li>
<a href="#advanced-topics" id="toc-advanced-topics" class="nav-link" data-scroll-target="#advanced-topics"><span class="header-section-number">8</span> Advanced topics</a>
  <ul class="collapse">
<li><a href="#sec-ifelse" id="toc-sec-ifelse" class="nav-link" data-scroll-target="#sec-ifelse"><span class="header-section-number">8.1</span> Recoding data (ifelse)</a></li>
  <li><a href="#sec-factors" id="toc-sec-factors" class="nav-link" data-scroll-target="#sec-factors"><span class="header-section-number">8.2</span> Factors and statistical data types</a></li>
  </ul>
</li>
  <li>
<a href="#seminar-tasks" id="toc-seminar-tasks" class="nav-link" data-scroll-target="#seminar-tasks"><span class="header-section-number">9</span> Seminar tasks</a>
  <ul class="collapse">
<li><a href="#student-dataset" id="toc-student-dataset" class="nav-link" data-scroll-target="#student-dataset"><span class="header-section-number">9.1</span> Student dataset</a></li>
  <li><a href="#teacher-dataset" id="toc-teacher-dataset" class="nav-link" data-scroll-target="#teacher-dataset"><span class="header-section-number">9.2</span> Teacher dataset</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">Piping and dplyr</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p>Piping allows us to break down complex tasks into manageable chunks that can be written and tested one after another. There are several powerful commands in the tidyverse as part of the <em>dplyr</em> package that can help us <code>group</code>, <code>filter</code>, <code>select</code>, <code>mutate</code> and <code>summarise</code> datasets. With this small set of commands we can use piping to convert massive datasets into simple and useful results.</p>
<p>Using the pipe <code>%&gt;%</code> command, we can feed the results from one command into the next command making for reusable and easy to read code.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="images/pipe_drawing.svg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">how piping works</figcaption></figure>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The pipe command we are using <code>%&gt;%</code> is from the <em>magrittr</em> package which is installed alongside the tidyverse. Recently <em>R</em> introduced another pipe <code>|&gt;</code> which offers very similar functionality and tutorials online might use either. The examples below use the <code>%&gt;%</code> pipe.</p>
</div>
</div>
<p>Let’s look at an example of using the pipe on the <code>PISA_2018</code> table to calculate the best performing OECD countries for maths <code>PV1MATH</code> by gender <code>ST004D01T</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb1-2"><a href="#cb1-2"></a>  <span class="fu">filter</span>(OECD <span class="sc">==</span> <span class="st">"Yes"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>  <span class="fu">group_by</span>(CNT, ST004D01T) <span class="sc">%&gt;%</span> </span>
<span id="cb1-4"><a href="#cb1-4"></a>  <span class="fu">summarise</span>(<span class="at">mean_maths =</span> <span class="fu">mean</span>(PV1MATH, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb1-5"><a href="#cb1-5"></a>            <span class="at">sd_maths =</span> <span class="fu">sd</span>(PV1MATH, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb1-6"><a href="#cb1-6"></a>            <span class="at">students =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST004D01T)) <span class="sc">%&gt;%</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(mean_maths))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 74 × 5
# Groups:   CNT [37]
   CNT            ST004D01T mean_maths sd_maths students
   &lt;fct&gt;          &lt;fct&gt;          &lt;dbl&gt;    &lt;dbl&gt;    &lt;int&gt;
 1 Japan          Male            533.     90.5     2989
 2 Korea          Male            530.    102.      3459
 3 Estonia        Male            528.     85.0     2665
 4 Japan          Female          523.     82.2     3120
 5 Korea          Female          523.     96.0     3191
 6 Switzerland    Male            520.     92.7     3033
 7 Estonia        Female          519.     76.0     2651
 8 Czech Republic Male            518.     98.0     3501
 9 Belgium        Male            518.     95.9     4204
10 Poland         Male            517.     91.8     2768
# ℹ 64 more rows</code></pre>
</div>
</div>
<ul>
<li>line 1 passes the whole <code>PISA_2018</code> dataset and pipes it into the next line <code>%&gt;%</code>
</li>
<li>line 2 <code>filters</code> out any results that are from non-OECD countries by finding all the rows where <code>OECD</code> equals <code>==</code> “Yes”, this is then piped to the next line</li>
<li>line 3 groups the data by country <code>CNT</code> and by student gender <code>ST004D01T</code>, this is then piped to the next line</li>
<li>line 4-6 the <code>summarise</code> command performs a calculation on the country and gender groupings returning three new columns, each command on a new line and separated by a comma: the mean value for maths <code>mean_maths</code>, the standard deviation <code>sd_maths</code> and a column telling us how many students were in each grouping using the <code>n()</code> which returns the number of rows in a group. These new columns and the grouping columns are then piped to the next line</li>
<li>line 7 filters out any gender <code>ST004D01T</code> that is <code>NA</code>. First is finds all the students that have <code>NA</code> as their gender by using <code>is.na(ST004D01T)</code>, then is <em>NOTs</em>/flips the result using the exclamation mark <code>!</code>, giving those students who don’t have their gender set to <code>NA</code>. The filtered data is then piped to the next line</li>
<li>line 8, finally we <code>arrange</code> / sort the results in <code>desc</code>ending order by the <code>mean_maths</code> column. The default for arrange is <em>ascending</em> order, leave out the <code>desc(  )</code> for the numbers to be ordered in the opposite way.</li>
</ul>
<p>Males get a slightly better maths score than Females for this <code>PV1MATH</code> score, other scores are available, please read <strong>?@sec-PV</strong> to find out more about the limitations of using this value.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>we met the assignment command earlier <code>&lt;-</code>. Within the tidyverse commands we use the equals sign instead <code>=</code>.</p>
</div>
</div>
<p>The commands we have just used come from a package within the <code>tidyverse</code> called <code>dplyr</code>, let’s take a look at what they do:</p>
<table class="table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead><tr class="header">
<th>command</th>
<th>purpose</th>
<th>example</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>select</td>
<td>reduce the dataframe to the fields that you specify</td>
<td><code>select(&lt;field&gt;, &lt;field&gt;, &lt;field&gt;)</code></td>
</tr>
<tr class="even">
<td>filter</td>
<td>get rid of rows that don’t meet one or more criteria</td>
<td><code>filter(&lt;field&gt; &lt;comparison&gt;)</code></td>
</tr>
<tr class="odd">
<td>group</td>
<td>group fields together to perform calculations</td>
<td><code>group_by(&lt;field&gt;, &lt;field&gt;))</code></td>
</tr>
<tr class="even">
<td>mutate</td>
<td>add new fields or change values in current fields</td>
<td><code>mutate(&lt;new_field&gt; = &lt;field&gt; / 2)</code></td>
</tr>
<tr class="odd">
<td>summarise</td>
<td>create summary data optionally using a grouping command</td>
<td><code>summarise(&lt;new_field&gt; = max(&lt;field&gt;))</code></td>
</tr>
<tr class="even">
<td>arrange</td>
<td>order the results by one or more fields</td>
<td><code>arrange(desc(&lt;field&gt;))</code></td>
</tr>
</tbody>
</table>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you want to explore more of the functions of <code>dplyr</code>, take a look at the <a href="https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf">helpsheet</a></p>
</div>
</div>
<div class="question">
<p>Adjust the code above to find out the lowest performing countries for reading <code>PV1READ</code> by gender that are not in the OECD</p>
<div class="cell">
<details><summary>answer</summary><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb3-2"><a href="#cb3-2"></a>  <span class="fu">filter</span>(OECD <span class="sc">==</span> <span class="st">"No"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>  <span class="fu">group_by</span>(CNT, ST004D01T) <span class="sc">%&gt;%</span> </span>
<span id="cb3-4"><a href="#cb3-4"></a>  <span class="fu">summarise</span>(<span class="at">mean_read =</span> <span class="fu">mean</span>(PV1READ, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb3-5"><a href="#cb3-5"></a>            <span class="at">sd_read =</span> <span class="fu">sd</span>(PV1READ, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb3-6"><a href="#cb3-6"></a>            <span class="at">students =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST004D01T)) <span class="sc">%&gt;%</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>  <span class="fu">arrange</span>(mean_read)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<section id="select" class="level1" data-number="1"><h1 data-number="1">
<span class="header-section-number">1</span> select</h1>
<p>The <code>PISA_2018</code> dataset has far too many fields, to reduce the number of fields to focus on just a few of them we can use <code>select</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>PISA_2018 <span class="sc">%&gt;%</span> <span class="fu">select</span>(CNT,ESCS, ST004D01T, ST003D02T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 612,004 × 4
   CNT       ESCS ST004D01T ST003D02T
   &lt;fct&gt;    &lt;dbl&gt; &lt;fct&gt;     &lt;fct&gt;    
 1 Albania  0.675 Male      February 
 2 Albania -0.757 Male      July     
 3 Albania -2.51  Female    April    
 4 Albania -3.18  Male      April    
 5 Albania -1.76  Male      March    
 6 Albania -1.49  Female    February 
 7 Albania NA     Female    July     
 8 Albania -3.25  Male      August   
 9 Albania -1.72  Female    March    
10 Albania NA     Female    July     
# ℹ 611,994 more rows</code></pre>
</div>
</div>
<p>You might also be in the situation where you want to select everything but one or two fields, you can do this with the negative signal <code>-</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>PISA_2018 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>CNT, <span class="sc">-</span>OECD)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 612,004 × 203
   ISCEDL       ISCEDD ISCEDO PROGN WVARSTRR COBN_F COBN_M COBN_S GRADE SUBNATIO
   &lt;fct&gt;        &lt;fct&gt;  &lt;fct&gt;  &lt;fct&gt;    &lt;dbl&gt; &lt;fct&gt;  &lt;fct&gt;  &lt;fct&gt;  &lt;fct&gt; &lt;fct&gt;   
 1 ISCED level… C      Vocat… Alba…        3 Alban… Alban… Alban… 0     Albania 
 2 ISCED level… C      Vocat… Alba…        3 Alban… Alban… Alban… 0     Albania 
 3 ISCED level… C      Vocat… Alba…        3 Alban… Alban… Alban… 0     Albania 
 4 ISCED level… C      Vocat… Alba…        3 Alban… Alban… Alban… 0     Albania 
 5 ISCED level… C      Vocat… Alba…        3 Alban… Alban… Alban… 0     Albania 
 6 ISCED level… C      Vocat… Alba…        3 Alban… Alban… Alban… 0     Albania 
 7 ISCED level… C      Vocat… Alba…        3 Missi… Missi… Missi… 0     Albania 
 8 ISCED level… C      Vocat… Alba…        3 Alban… Alban… Alban… 0     Albania 
 9 ISCED level… C      Vocat… Alba…        3 Alban… Alban… Alban… 0     Albania 
10 ISCED level… C      Vocat… Alba…        3 Missi… Missi… Missi… 0     Albania 
# ℹ 611,994 more rows
# ℹ 193 more variables: STRATUM &lt;fct&gt;, ESCS &lt;dbl&gt;, LANGN &lt;fct&gt;, LMINS &lt;dbl&gt;,
#   OCOD1 &lt;fct&gt;, OCOD2 &lt;fct&gt;, REPEAT &lt;fct&gt;, CNTRYID &lt;fct&gt;, CNTSCHID &lt;dbl&gt;,
#   CNTSTUID &lt;dbl&gt;, NatCen &lt;fct&gt;, ADMINMODE &lt;fct&gt;, LANGTEST_QQQ &lt;fct&gt;,
#   LANGTEST_COG &lt;fct&gt;, BOOKID &lt;fct&gt;, ST001D01T &lt;fct&gt;, ST003D02T &lt;fct&gt;,
#   ST003D03T &lt;fct&gt;, ST004D01T &lt;fct&gt;, ST005Q01TA &lt;fct&gt;, ST007Q01TA &lt;fct&gt;,
#   ST011Q01TA &lt;fct&gt;, ST011Q02TA &lt;fct&gt;, ST011Q03TA &lt;fct&gt;, ST011Q04TA &lt;fct&gt;, …</code></pre>
</div>
</div>
<p>You might find that you have a vector of column names that you want to select, to do this, we can use the <code>any_of</code> command:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>my_fields <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"CNTSTUID"</span>, <span class="st">"CNTSCHID"</span>, <span class="st">"ST004D01T"</span>)</span>
<span id="cb8-2"><a href="#cb8-2"></a>PISA_2018 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">any_of</span>(my_fields))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 612,004 × 3
   CNTSTUID CNTSCHID ST004D01T
      &lt;dbl&gt;    &lt;dbl&gt; &lt;fct&gt;    
 1   800251   800002 Male     
 2   800402   800002 Male     
 3   801902   800002 Female   
 4   803546   800002 Male     
 5   804776   800002 Male     
 6   804825   800002 Female   
 7   804983   800002 Female   
 8   805287   800002 Male     
 9   805601   800002 Female   
10   806295   800002 Female   
# ℹ 611,994 more rows</code></pre>
</div>
</div>
<p>With hundreds of fields, you might want to focus on fields whose names match a certain pattern, to do this you can use <code>starts_with</code>, <code>ends_with</code>, <code>contains</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>PISA_2018 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">ends_with</span>(<span class="st">"NA"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 612,004 × 19
   ST011Q16NA ST012Q05NA  ST012Q06NA ST012Q09NA ST125Q01NA ST060Q01NA ST061Q01NA
   &lt;fct&gt;      &lt;fct&gt;       &lt;fct&gt;      &lt;fct&gt;      &lt;fct&gt;           &lt;dbl&gt; &lt;fct&gt;     
 1 Yes        &lt;NA&gt;        One        One        6 years o…         31 45        
 2 Yes        Three or m… One        None       4 years            37 45        
 3 No         One         None       None       4 years            NA 45        
 4 No         &lt;NA&gt;        None       One        1 year or…         31 45        
 5 No         One         One        None       3 years            80 100       
 6 No         Three or m… One        None       6 years o…         24 25        
 7 &lt;NA&gt;       &lt;NA&gt;        &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;               NA &lt;NA&gt;      
 8 No         None        None       None       1 year or…         NA 45        
 9 Yes        Three or m… One        One        4 years            36 45        
10 &lt;NA&gt;       &lt;NA&gt;        &lt;NA&gt;       &lt;NA&gt;       &lt;NA&gt;               NA &lt;NA&gt;      
# ℹ 611,994 more rows
# ℹ 12 more variables: IC009Q05NA &lt;fct&gt;, IC009Q06NA &lt;fct&gt;, IC009Q07NA &lt;fct&gt;,
#   IC009Q10NA &lt;fct&gt;, IC009Q11NA &lt;fct&gt;, IC008Q07NA &lt;fct&gt;, IC008Q13NA &lt;fct&gt;,
#   IC010Q02NA &lt;fct&gt;, IC010Q05NA &lt;fct&gt;, IC010Q06NA &lt;fct&gt;, IC010Q09NA &lt;fct&gt;,
#   IC010Q10NA &lt;fct&gt;</code></pre>
</div>
</div>
<p>When you come to building your statistical models you often need to use <em>numeric</em> data, you can find the columns that have only numbers in them by the following. Be warned though, sometimes there are numeric fields which have a few words in them, so R treats them as characters. Use the PISA <a href="https://webfs.oecd.org/pisa2018/PISA2018_CODEBOOK.xlsx">codebook</a> to help work out where those numbers are.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>PISA_2018 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">where</span>(is.numeric)) <span class="sc">%&gt;%</span> <span class="fu">names</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "WVARSTRR"   "ESCS"       "LMINS"      "CNTSCHID"   "CNTSTUID"  
 [6] "ST060Q01NA" "MMINS"      "SMINS"      "TMINS"      "CULTPOSS"  
[11] "WEALTH"     "PV1MATH"    "PV1READ"    "PV1SCIE"    "ATTLNACT"  
 [ reached getOption("max.print") -- omitted 2 entries ]</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you do want to change the type of a column to numeric you are going to neeed to:</p>
<ul>
<li>
<code>filter</code> out the offending rows, and</li>
<li>
<code>mutate</code> the column to be numeric: <code>col = as.numeric(col)</code>
</li>
</ul>
</div>
</div>
<section id="questions" class="level2" data-number="1.1"><h2 data-number="1.1" class="anchored" data-anchor-id="questions">
<span class="header-section-number">1.1</span> Questions</h2>
<div class="question">
<ol type="1">
<li>Spot the three errors with the following <code>select</code> statement</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>PISA_2018 </span>
<span id="cb14-2"><a href="#cb14-2"></a>  <span class="fu">select</span>(CNT BELONG) <span class="sc">%&gt;%</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details><summary>answer</summary><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>PISA_2018 <span class="sc">%&gt;%</span>  <span class="co">#1 missing pipe</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>  <span class="fu">select</span>(CNT, BELONG) <span class="co">#2 no comma between column names, #3 stray pipe on end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>Write a <code>select</code> statement to display the month <code>ST003D02T</code> and year of birth <code>ST003D03T</code> and the gender <code>ST004D01T</code> of each student.</li>
</ol>
<div class="cell">
<details><summary>answer</summary><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb16-2"><a href="#cb16-2"></a>  <span class="fu">select</span>(ST003D02T, ST003D03T, ST004D01T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="3" type="1">
<li>Write a <code>select</code> statement to show all the fields that are to do with digital skills, e.g.&nbsp;<code>IC150Q01HA</code>
</li>
</ol>
<div class="cell">
<details><summary>answer</summary><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb17-2"><a href="#cb17-2"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"IC15"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="4" type="1">
<li>[EXTENSION] Adjust the answer to Q3 so that you select the gender <code>ST004D01T</code> and the ID <code>CNTSTUID</code> of each student in addition to the <code>IC15____</code> fields</li>
</ol>
<div class="cell">
<details><summary>answer</summary><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb18-2"><a href="#cb18-2"></a>  <span class="fu">select</span>(CNTSTUID, ST004D01T, <span class="fu">starts_with</span>(<span class="st">"IC15"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</section></section><section id="filter" class="level1" data-number="2"><h1 data-number="2">
<span class="header-section-number">2</span> filter</h1>
<p>Not only does the <code>PISA_2018</code> dataset have a huge number of columns, it has hundred of thousands of rows. We want to <code>filter</code> this down to the students that we are interested in, i.e.&nbsp;filter out data that isn’t useful for our analysis. If we only wanted the results that were Male, we could do the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb19-2"><a href="#cb19-2"></a>  <span class="fu">select</span>(CNT, ESCS, ST004D01T, ST003D02T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb19-3"><a href="#cb19-3"></a>  <span class="fu">filter</span>(ST004D01T <span class="sc">==</span> <span class="st">"Male"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 307,044 × 5
   CNT       ESCS ST004D01T ST003D02T PV1MATH
   &lt;fct&gt;    &lt;dbl&gt; &lt;fct&gt;     &lt;fct&gt;       &lt;dbl&gt;
 1 Albania  0.675 Male      February     490.
 2 Albania -0.757 Male      July         462.
 3 Albania -3.18  Male      April        483.
 4 Albania -1.76  Male      March        460.
 5 Albania -3.25  Male      August       441.
 6 Albania NA     Male      March        280.
 7 Albania -1.09  Male      March        523.
 8 Albania -1.24  Male      June         314.
 9 Albania -0.164 Male      August       428.
10 Albania -0.451 Male      December     369.
# ℹ 307,034 more rows</code></pre>
</div>
</div>
<p>We can combine <code>filter</code> commands to look for <code>Males</code> born in <code>September</code> and where the <code>PV1MATH</code> figure is greater than <code>750</code>. We can list multiple criteria in the filter by separating the criteria with commas, using commas mean that all of these criteria need to be <code>TRUE</code> for a row to be returned. A comma in a filter is the equivalent of an <code>AND</code>, :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb21-2"><a href="#cb21-2"></a>  <span class="fu">select</span>(CNT, ESCS, ST004D01T, ST003D02T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3"></a>  <span class="fu">filter</span>(ST004D01T <span class="sc">==</span> <span class="st">"Male"</span>,</span>
<span id="cb21-4"><a href="#cb21-4"></a>         ST003D02T <span class="sc">==</span> <span class="st">"September"</span>,</span>
<span id="cb21-5"><a href="#cb21-5"></a>         PV1MATH <span class="sc">&gt;</span> <span class="dv">750</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 56 × 5
   CNT                    ESCS ST004D01T ST003D02T PV1MATH
   &lt;fct&gt;                 &lt;dbl&gt; &lt;fct&gt;     &lt;fct&gt;       &lt;dbl&gt;
 1 United Arab Emirates  0.861 Male      September    760.
 2 Belgium               0.887 Male      September    751.
 3 Bulgaria             -0.160 Male      September    752.
 4 Canada                1.38  Male      September    751.
 5 Canada                1.16  Male      September    760.
 6 Canada                0.760 Male      September    770.
 7 Switzerland           0.814 Male      September    783.
 8 Germany               0.740 Male      September    762.
 9 Spain                 1.46  Male      September    787.
10 Estonia               0.897 Male      September    752.
# ℹ 46 more rows</code></pre>
</div>
</div>
<p>You can also write it as an ampersand <code>&amp;</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb23-2"><a href="#cb23-2"></a>  <span class="fu">select</span>(CNT, ESCS, ST004D01T, ST003D02T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb23-3"><a href="#cb23-3"></a>  <span class="fu">filter</span>(ST004D01T <span class="sc">==</span> <span class="st">"Male"</span> <span class="sc">&amp;</span></span>
<span id="cb23-4"><a href="#cb23-4"></a>         ST003D02T <span class="sc">==</span> <span class="st">"September"</span> <span class="sc">&amp;</span></span>
<span id="cb23-5"><a href="#cb23-5"></a>         PV1MATH <span class="sc">&gt;</span> <span class="dv">750</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Remember to include the <code>==</code> sign when looking to filter on equality; additionally, you can use <code>!=</code> (not equals), <code>&gt;=</code>, <code>&lt;=</code>, <code>&gt;</code>, <code>&lt;</code>.</p>
<p>Remember matching is case sensitive, “june” <code>!=</code> “June”</p>
</div>
</div>
<p>Rather than just looking at September born students, we want to find all the students born in the Autumn term. But if we add a couple more criteria on <code>ST003D02T</code> nothing is returned!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb24-2"><a href="#cb24-2"></a>  <span class="fu">select</span>(CNT, ESCS, ST004D01T, ST003D02T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb24-3"><a href="#cb24-3"></a>  <span class="fu">filter</span>(ST004D01T <span class="sc">==</span> <span class="st">"Male"</span>,</span>
<span id="cb24-4"><a href="#cb24-4"></a>         ST003D02T <span class="sc">==</span> <span class="st">"September"</span>,</span>
<span id="cb24-5"><a href="#cb24-5"></a>         ST003D02T <span class="sc">==</span> <span class="st">"October"</span>,</span>
<span id="cb24-6"><a href="#cb24-6"></a>         ST003D02T <span class="sc">==</span> <span class="st">"November"</span>,</span>
<span id="cb24-7"><a href="#cb24-7"></a>         ST003D02T <span class="sc">==</span> <span class="st">"December"</span>,</span>
<span id="cb24-8"><a href="#cb24-8"></a>         PV1MATH <span class="sc">&gt;</span> <span class="dv">750</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 0 × 5
# ℹ 5 variables: CNT &lt;fct&gt;, ESCS &lt;dbl&gt;, ST004D01T &lt;fct&gt;, ST003D02T &lt;fct&gt;,
#   PV1MATH &lt;dbl&gt;</code></pre>
</div>
</div>
<p>The reason is R is looking for inidividual students born in September <code>AND</code> October <code>AND</code> November <code>AND</code> December. As a student can only have one birth month there are no students that meet this criteria. We need to use <code>OR</code> :</p>
<p>To create an <code>OR</code> in a filter we use the bar <code>|</code> character, the below looks for all students who are “Male” <code>AND</code> were born in “September” <code>OR</code> “October” <code>OR</code> “November” <code>OR</code> “December”, <code>AND</code> have a <code>PV1MATH</code> &gt; 750.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb26-2"><a href="#cb26-2"></a>  <span class="fu">select</span>(CNT, ESCS, ST004D01T, ST003D02T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb26-3"><a href="#cb26-3"></a>  <span class="fu">filter</span>(ST004D01T <span class="sc">==</span> <span class="st">"Male"</span>,</span>
<span id="cb26-4"><a href="#cb26-4"></a>         (ST003D02T <span class="sc">==</span> <span class="st">"September"</span> <span class="sc">|</span> ST003D02T <span class="sc">==</span> <span class="st">"October"</span> <span class="sc">|</span> ST003D02T <span class="sc">==</span> <span class="st">"November"</span> <span class="sc">|</span> ST003D02T <span class="sc">==</span> <span class="st">"December"</span>),</span>
<span id="cb26-5"><a href="#cb26-5"></a>         PV1MATH <span class="sc">&gt;</span> <span class="dv">750</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 175 × 5
   CNT                     ESCS ST004D01T ST003D02T PV1MATH
   &lt;fct&gt;                  &lt;dbl&gt; &lt;fct&gt;     &lt;fct&gt;       &lt;dbl&gt;
 1 Albania               0.539  Male      October      789.
 2 United Arab Emirates  0.861  Male      September    760.
 3 United Arab Emirates  0.813  Male      October      753.
 4 United Arab Emirates  0.953  Male      November     766.
 5 United Arab Emirates  0.930  Male      November     773.
 6 United Arab Emirates  1.44   Male      October      752.
 7 Australia             1.73   Male      December     756.
 8 Australia            -0.0537 Male      October      827.
 9 Australia             1.18   Male      November     758.
10 Australia             1.13   Male      October      757.
# ℹ 165 more rows</code></pre>
</div>
</div>
<p>It’s neater, maybe, to use the <code>%in%</code> command, which checks to see if the value in a column is present in a vector, this can mimic the <code>OR</code>/<code>|</code> command:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a>PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb28-2"><a href="#cb28-2"></a>  <span class="fu">select</span>(CNT, ESCS, ST004D01T, ST003D02T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb28-3"><a href="#cb28-3"></a>  <span class="fu">filter</span>(ST004D01T <span class="sc">==</span> <span class="st">"Male"</span>,</span>
<span id="cb28-4"><a href="#cb28-4"></a>         ST003D02T <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"September"</span>, <span class="st">"October"</span>, <span class="st">"November"</span>, <span class="st">"December"</span>),</span>
<span id="cb28-5"><a href="#cb28-5"></a>         PV1MATH <span class="sc">&gt;</span> <span class="dv">750</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>When building filters you need to know the range of values that a column can take, we can do this in several ways:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="co"># show the possible levels</span></span>
<span id="cb29-2"><a href="#cb29-2"></a><span class="fu">levels</span>(PISA_2018<span class="sc">$</span>ST013Q01TA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "0-10 books"          "11-25 books"         "26-100 books"       
 [4] "101-200 books"       "201-500 books"       "More than 500 books"
 [7] "Valid Skip"          "Not Applicable"      "Invalid"            
[10] "No Response"        </code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="co"># show the actual unique values in a field</span></span>
<span id="cb31-2"><a href="#cb31-2"></a><span class="co"># this might be a slightly smaller set of values</span></span>
<span id="cb31-3"><a href="#cb31-3"></a><span class="fu">unique</span>(PISA_2018<span class="sc">$</span>ST013Q01TA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0-10 books          11-25 books         &lt;NA&gt;               
[4] 26-100 books        101-200 books       More than 500 books
[7] 201-500 books      
10 Levels: 0-10 books 11-25 books 26-100 books 101-200 books ... No Response</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a><span class="co"># You might also want to read the label of a field</span></span>
<span id="cb33-2"><a href="#cb33-2"></a><span class="fu">attr</span>(PISA_2018<span class="sc">$</span>ST013Q01TA, <span class="st">"label"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "How many books are there in your home?"</code></pre>
</div>
</div>
</div>
</div>
<section id="questions-1" class="level2" data-number="2.1"><h2 data-number="2.1" class="anchored" data-anchor-id="questions-1">
<span class="header-section-number">2.1</span> Questions</h2>
<div class="question">
<ol type="1">
<li>Spot the <strong>three</strong> errors with the following <code>select</code> statement</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb35-2"><a href="#cb35-2"></a>  <span class="fu">select</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb35-3"><a href="#cb35-3"></a>  <span class="fu">filter</span>(CNT <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"France"</span>, <span class="st">"belgium"</span>)</span>
<span id="cb35-4"><a href="#cb35-4"></a>         ESCS <span class="sc">&lt;</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details><summary>answer</summary><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a>PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb36-2"><a href="#cb36-2"></a>  <span class="fu">select</span>(CNT, ESCS) <span class="sc">%&gt;%</span> <span class="co">#1 you have ESCS in the filter, it needs to be in the select as well</span></span>
<span id="cb36-3"><a href="#cb36-3"></a>  <span class="fu">filter</span>(CNT <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"France"</span>, <span class="st">"Belgium"</span>), <span class="co">#2 Belgium needs a capital letter</span></span>
<span id="cb36-4"><a href="#cb36-4"></a>                                          <span class="co">#3 the %in% command needs percentages</span></span>
<span id="cb36-5"><a href="#cb36-5"></a>                                          <span class="co">#4 you need a comma (or &amp;) at the end of the line</span></span>
<span id="cb36-6"><a href="#cb36-6"></a>         ESCS <span class="sc">&lt;</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>Use <code>filter</code> to find all the students with <code>Three or more</code> cars in their home <code>ST012Q02TA</code>. How does this compare to those with no <code>None</code> cars?</li>
</ol>
<div class="cell">
<details><summary>answer</summary><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>cars_3 <span class="ot">&lt;-</span> PISA_2018 <span class="sc">%&gt;%</span></span>
<span id="cb37-2"><a href="#cb37-2"></a>  <span class="fu">select</span>(CNT, ST012Q02TA) <span class="sc">%&gt;%</span></span>
<span id="cb37-3"><a href="#cb37-3"></a>  <span class="fu">filter</span>(ST012Q02TA <span class="sc">==</span> <span class="st">"Three or more"</span>)</span>
<span id="cb37-4"><a href="#cb37-4"></a></span>
<span id="cb37-5"><a href="#cb37-5"></a>cars_0 <span class="ot">&lt;-</span> PISA_2018 <span class="sc">%&gt;%</span></span>
<span id="cb37-6"><a href="#cb37-6"></a>  <span class="fu">select</span>(CNT, ST012Q02TA) <span class="sc">%&gt;%</span></span>
<span id="cb37-7"><a href="#cb37-7"></a>  <span class="fu">filter</span>(ST012Q02TA <span class="sc">==</span> <span class="st">"None"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="3" type="1">
<li>Adjust your code in Q2. to find the number of students with <code>Three or more</code> cars in their home <code>ST012Q02TA</code> in <code>Italy</code>, how does this compare with <code>Spain</code>?</li>
</ol>
<div class="cell">
<details><summary>answer</summary><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>PISA_2018 <span class="sc">%&gt;%</span></span>
<span id="cb38-2"><a href="#cb38-2"></a>  <span class="fu">select</span>(CNT, ST012Q02TA) <span class="sc">%&gt;%</span></span>
<span id="cb38-3"><a href="#cb38-3"></a>  <span class="fu">filter</span>(ST012Q02TA <span class="sc">==</span> <span class="st">"Three or more"</span>,</span>
<span id="cb38-4"><a href="#cb38-4"></a>         CNT <span class="sc">==</span> <span class="st">"Italy"</span>)</span>
<span id="cb38-5"><a href="#cb38-5"></a></span>
<span id="cb38-6"><a href="#cb38-6"></a>PISA_2018 <span class="sc">%&gt;%</span></span>
<span id="cb38-7"><a href="#cb38-7"></a>  <span class="fu">select</span>(CNT, ST012Q02TA) <span class="sc">%&gt;%</span></span>
<span id="cb38-8"><a href="#cb38-8"></a>  <span class="fu">filter</span>(ST012Q02TA <span class="sc">==</span> <span class="st">"Three or more"</span>,</span>
<span id="cb38-9"><a href="#cb38-9"></a>         CNT <span class="sc">==</span> <span class="st">"Spain"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="4" type="1">
<li>Write a <code>filter</code> to create a table for the number of <code>Female</code> students with reading <code>PV1READ</code> scores lower than 400 in the <code>United Kingdom</code>, store the result as <code>read_low_female</code>, repeat but for <code>Male</code> students and store as <code>read_low_male</code>. Use <code><a href="https://rdrr.io/r/base/nrow.html">nrow()</a></code> to work out if there are more males or females with a low reading score in the UK</li>
</ol>
<div class="cell">
<details><summary>answer</summary><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a>read_low_female <span class="ot">&lt;-</span> PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb39-2"><a href="#cb39-2"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>,</span>
<span id="cb39-3"><a href="#cb39-3"></a>         PV1READ <span class="sc">&lt;</span> <span class="dv">400</span>,</span>
<span id="cb39-4"><a href="#cb39-4"></a>         ST004D01T <span class="sc">==</span> <span class="st">"Female"</span>)</span>
<span id="cb39-5"><a href="#cb39-5"></a></span>
<span id="cb39-6"><a href="#cb39-6"></a>read_low_male <span class="ot">&lt;-</span> PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb39-7"><a href="#cb39-7"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>,</span>
<span id="cb39-8"><a href="#cb39-8"></a>         PV1READ <span class="sc">&lt;</span> <span class="dv">400</span>,</span>
<span id="cb39-9"><a href="#cb39-9"></a>         ST004D01T <span class="sc">==</span> <span class="st">"Male"</span>)</span>
<span id="cb39-10"><a href="#cb39-10"></a></span>
<span id="cb39-11"><a href="#cb39-11"></a><span class="fu">nrow</span>(read_low_female)</span>
<span id="cb39-12"><a href="#cb39-12"></a><span class="fu">nrow</span>(read_low_male)</span>
<span id="cb39-13"><a href="#cb39-13"></a></span>
<span id="cb39-14"><a href="#cb39-14"></a><span class="co"># You could also pipe the whole dataframe into nrow()</span></span>
<span id="cb39-15"><a href="#cb39-15"></a>PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb39-16"><a href="#cb39-16"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>,</span>
<span id="cb39-17"><a href="#cb39-17"></a>         PV1READ <span class="sc">&lt;</span> <span class="dv">400</span>,</span>
<span id="cb39-18"><a href="#cb39-18"></a>         ST004D01T <span class="sc">==</span> <span class="st">"Female"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb39-19"><a href="#cb39-19"></a>  <span class="fu">nrow</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="5" type="1">
<li>How many students in the United Kingdom had no television <code>ST012Q01TA</code> <em>OR</em> no connection to the internet <code>ST011Q06TA</code>. <strong>HINT</strong>: use <code>levels(PISA_2018$ST012Q01TA)</code> to look at the levels available for each column.</li>
</ol>
<div class="cell">
<details><summary>answer</summary><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>PISA_2018 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>, </span>
<span id="cb40-2"><a href="#cb40-2"></a>                     ST011Q06TA <span class="sc">==</span> <span class="st">"No"</span> <span class="sc">|</span></span>
<span id="cb40-3"><a href="#cb40-3"></a>                     ST012Q01TA <span class="sc">==</span> <span class="st">"None"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="6" type="1">
<li>Which countr[y|ies] had students with <code>NA</code> for Gender?</li>
</ol>
<div class="cell">
<details><summary>answer</summary><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a>PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb41-2"><a href="#cb41-2"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(ST004D01T)) <span class="sc">%&gt;%</span></span>
<span id="cb41-3"><a href="#cb41-3"></a>  <span class="fu">select</span>(CNT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</section></section><section id="sec-renaming" class="level1" data-number="3"><h1 data-number="3">
<span class="header-section-number">3</span> renaming columns</h1>
<p>Very often when dealing with datasets such as PISA or TIMSS, the column names can be very confusing without a reference key, e.g.&nbsp;<code>ST004D01T</code>, <code>BCBG10B</code> and <code>BCBG11.</code> To rename columns in the tidyverse we use the <code>rename(&lt;new_name&gt; = &lt;old_name&gt;)</code> command. For example, if you wanted to rename the rather confusing student column for <em>gender</em>, also known as <code>ST004D01T</code>, and the column for having a <em>dictionary</em> at home, also known as <code>ST011Q12TA</code>, you could use:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>PISA_2018 <span class="sc">%&gt;%</span></span>
<span id="cb42-2"><a href="#cb42-2"></a>  <span class="fu">rename</span>(<span class="at">gender =</span> ST004D01T,</span>
<span id="cb42-3"><a href="#cb42-3"></a>         <span class="at">dictionary =</span> ST011Q12TA) <span class="sc">%&gt;%</span></span>
<span id="cb42-4"><a href="#cb42-4"></a>  <span class="fu">select</span>(CNT, gender, dictionary) <span class="sc">%&gt;%</span> </span>
<span id="cb42-5"><a href="#cb42-5"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   CNT                    gender                dictionary    
 Spain               : 35943   Female        :304958   Yes           :524311  
 Canada              : 22653   Male          :307044   No            : 66730  
 Kazakhstan          : 19507   Valid Skip    :     0   Valid Skip    :     0  
 United Arab Emirates: 19277   Not Applicable:     0   Not Applicable:     0  
 Australia           : 14273   Invalid       :     0   Invalid       :     0  
 [ reached getOption("max.print") -- omitted 2 rows ]</code></pre>
</div>
</div>
<p>If you want to change the name of the column so that it stays when you need to perform another calculation, remember to <em>assign</em> the renamed dataframe back to the original dataframe. But be warned, you’ll need to reload the full dataset to restore the original names:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>PISA_2018 <span class="ot">&lt;-</span> PISA_2018 <span class="sc">%&gt;%</span></span>
<span id="cb44-2"><a href="#cb44-2"></a>    <span class="fu">rename</span>(<span class="at">gender =</span> ST004D01T,</span>
<span id="cb44-3"><a href="#cb44-3"></a>           <span class="at">dictionary =</span> ST011Q12TA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="group_by-and-summarise" class="level1" data-number="4"><h1 data-number="4">
<span class="header-section-number">4</span> group_by and summarise</h1>
<p>So far we have looked at ways to return rows that meet certain criteria. Using <code>group_by</code> and <code>summarise</code> we can start to analyse data for different groups of students. For example, let’s look at the number of students who don’t have internet connections at home <code>ST011Q06TA</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a>PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb45-2"><a href="#cb45-2"></a>  <span class="fu">group_by</span>(ST011Q06TA) <span class="sc">%&gt;%</span></span>
<span id="cb45-3"><a href="#cb45-3"></a>  <span class="fu">summarise</span>(<span class="at">student_n =</span> <span class="fu">n</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  ST011Q06TA student_n
  &lt;fct&gt;          &lt;int&gt;
1 Yes           543010
2 No             49703
3 &lt;NA&gt;           19291</code></pre>
</div>
</div>
<ul>
<li>Line 1 passes the full <code>PISA_2018</code> to the pipe</li>
<li>Line 2 makes groups within <code>PISA_2018</code> using the unique values of <code>ST011Q06TA</code>
</li>
<li>Line 3, these groups are then passed to <code>summarise</code>, which creates a new column called <code>student_n</code> and stores the number of rows in each <code>ST011Q06TA</code> group using the <code>n()</code> command. <code>summarise</code> only returns the columns it creates, or are in the <code>group_by</code>, everything else is discarded.</li>
</ul>
<p>What we might want to do is look at this data from a country by country perspective, by adding another field to the <code>group_by()</code> command, we then group by the unique combination of countries <code>CNT</code> and internet access <code>ST011Q06TA</code>, e.g.&nbsp;Albania+Yes; Albania+No; Albania+NA; Brazil+Yes; etc</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a>int_by_cnt <span class="ot">&lt;-</span> PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb47-2"><a href="#cb47-2"></a>  <span class="fu">group_by</span>(CNT, ST011Q06TA) <span class="sc">%&gt;%</span></span>
<span id="cb47-3"><a href="#cb47-3"></a>  <span class="fu">summarise</span>(<span class="at">student_n =</span> <span class="fu">n</span>())</span>
<span id="cb47-4"><a href="#cb47-4"></a></span>
<span id="cb47-5"><a href="#cb47-5"></a><span class="fu">print</span>(int_by_cnt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 240 × 3
# Groups:   CNT [80]
   CNT                  ST011Q06TA student_n
   &lt;fct&gt;                &lt;fct&gt;          &lt;int&gt;
 1 Albania              Yes             5059
 2 Albania              No              1084
 3 Albania              &lt;NA&gt;             216
 4 United Arab Emirates Yes            17616
 5 United Arab Emirates No               949
 6 United Arab Emirates &lt;NA&gt;             712
 7 Argentina            Yes             9871
 8 Argentina            No              1781
 9 Argentina            &lt;NA&gt;             323
10 Australia            Yes            12547
# ℹ 230 more rows</code></pre>
</div>
</div>
<p><code>summarise</code> can also be used to work out statistics by grouping. For example, if you wanted to find out the <code>max</code>, <code>mean</code> and <code>min</code> science grade <code>PV1SCIE</code> by country <code>CNT</code>, you could do the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a>PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb49-2"><a href="#cb49-2"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb49-3"><a href="#cb49-3"></a>  <span class="fu">summarise</span>(<span class="at">sci_max  =</span> <span class="fu">max</span>(PV1SCIE,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb49-4"><a href="#cb49-4"></a>            <span class="at">sci_mean =</span> <span class="fu">mean</span>(PV1SCIE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb49-5"><a href="#cb49-5"></a>            <span class="at">sci_min  =</span> <span class="fu">min</span>(PV1SCIE,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 80 × 4
   CNT                    sci_max sci_mean sci_min
   &lt;fct&gt;                    &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;
 1 Albania                   674.     417.   166. 
 2 United Arab Emirates      778.     425.    86.3
 3 Argentina                 790.     418.   138. 
 4 Australia                 879.     502.   153. 
 5 Austria                   779.     493.   175. 
 6 Belgium                   764.     502.   196. 
 7 Bulgaria                  741.     426.   145. 
 8 Bosnia and Herzegovina    664.     398.   152. 
 9 Belarus                   799.     474.   192. 
10 Brazil                    747.     407.    95.6
# ℹ 70 more rows</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>group_by()</code> can have unintended consequences in your code if you are saving your pipes to new dataframes. To be safe your can clear any grouping by adding: <code>my_data %&gt;% ungroup()</code></p>
</div>
</div>
<section id="questions-2" class="level2" data-number="4.1"><h2 data-number="4.1" class="anchored" data-anchor-id="questions-2">
<span class="header-section-number">4.1</span> Questions</h2>
<div class="question">
<ol type="1">
<li>Spot the <strong>three</strong> errors with the following <code>summarise</code> statement</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a>PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb51-2"><a href="#cb51-2"></a>  <span class="fu">group</span>(CNT)</span>
<span id="cb51-3"><a href="#cb51-3"></a>  <span class="fu">summarise</span>(<span class="at">num_stus =</span> n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details><summary>answer</summary><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a>PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb52-2"><a href="#cb52-2"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span> <span class="co">#1 group_by NOT group #2 missing pipe %&gt;%</span></span>
<span id="cb52-3"><a href="#cb52-3"></a>  <span class="fu">summarise</span>(<span class="at">num_stus =</span> <span class="fu">n</span>()) <span class="co">#3 = n() not = n</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>Write a <code>group_by</code> and <code>summarise</code> statement to work out the <code>mean</code> and <code>median</code> cultural capital value <code>ESCS</code> for each student by country <code>CNT</code>
</li>
</ol>
<div class="cell">
<details><summary>answer</summary><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a>PISA_2018 <span class="sc">%&gt;%</span></span>
<span id="cb53-2"><a href="#cb53-2"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb53-3"><a href="#cb53-3"></a>  <span class="fu">summarise</span>(<span class="at">escs_mean =</span> <span class="fu">mean</span>(ESCS, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb53-4"><a href="#cb53-4"></a>            <span class="at">escs_median =</span> <span class="fu">median</span>(ESCS, <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="3" type="1">
<li>Using <code>summarise</code> work out, <code>Yes</code> or <code>No</code>, by country <code>CNT</code> and gender <code>ST004D01T</code>, whether students “reduce the energy I use at home […] to protect the environment.” <code>ST222Q01HA</code>. Filter out any <code>NA</code> values on <code>ST222Q01HA</code>:</li>
</ol>
<div class="cell">
<details><summary>answer</summary><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a>PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb54-2"><a href="#cb54-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST222Q01HA)) <span class="sc">%&gt;%</span></span>
<span id="cb54-3"><a href="#cb54-3"></a>  <span class="fu">group_by</span>(CNT, ST004D01T, ST222Q01HA) <span class="sc">%&gt;%</span> </span>
<span id="cb54-4"><a href="#cb54-4"></a>  <span class="fu">summarise</span>(<span class="at">n=</span><span class="fu">n</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</section></section><section id="sec-mutate" class="level1" data-number="5"><h1 data-number="5">
<span class="header-section-number">5</span> mutate</h1>
<p>Sometimes you will want to adjust the values stored in a field, e.g.&nbsp;converting a distance in miles into kilometres; or compute a new fields based on other fields, e.g.&nbsp;working out a total grade given the parts of a test. To do this we can use <code>mutate</code>. Unlike <code>summarise</code>, <code>mutate</code> retains all the other columns either adding a new column or changing an existing one</p>
<blockquote class="blockquote">
<p><code>mutate(&lt;field&gt; = &lt;field_calculation&gt;)</code></p>
</blockquote>
<p>The <code>PISA_2018</code> dataset has results for maths <code>PV1MATH</code>, science <code>PV1SCIE</code> and reading <code>PV1READ</code>. We could combine these to create an overall <code>PISA_grade</code>, and <code>PISA_mean</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1"></a>PISA_2018 <span class="sc">%&gt;%</span></span>
<span id="cb55-2"><a href="#cb55-2"></a>  <span class="fu">mutate</span>(<span class="at">PV1_total =</span> PV1MATH <span class="sc">+</span> PV1SCIE <span class="sc">+</span> PV1READ,</span>
<span id="cb55-3"><a href="#cb55-3"></a>         <span class="at">PV1_mean =</span> PV1_total<span class="sc">/</span><span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb55-4"><a href="#cb55-4"></a>  <span class="fu">select</span>(CNT, ESCS, PV1_total, PV1_mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 612,004 × 4
   CNT       ESCS PV1_total PV1_mean
   &lt;fct&gt;    &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
 1 Albania  0.675     1311.     437.
 2 Albania -0.757     1319.     440.
 3 Albania -2.51      1158.     386.
 4 Albania -3.18      1424.     475.
 5 Albania -1.76      1094.     365.
 6 Albania -1.49      1004.     335.
 7 Albania NA         1311.     437.
 8 Albania -3.25      1104.     368.
 9 Albania -1.72      1268.     423.
10 Albania NA         1213.     404.
# ℹ 611,994 more rows</code></pre>
</div>
</div>
<ul>
<li>line 2 <code>mutate</code> creates a new field called <code>PV1_total</code> made up by adding together the columns for maths, science and reading. Each column acts like a vector and adding them together is the equivalent of adding each students individual grades together, row by row. See <strong>?@sec-vectors</strong> for more details on vector addition.</li>
<li>line 3 inside the same <code>mutate</code> statement, we take the <code>PV1_total</code> calculated on line 2 and divide it by 3, to give us a mean value, this is then assigned to a new column, <code>PV1_mean</code>.</li>
<li>line 4 this line <code>select</code>s only the fields that we are interested in, dropping the others</li>
</ul>
<p>We can use <code>mutate</code> to create subsets of data in fields. For example, if we wanted to see how many students in each country were high performing readers, specified by getting a reading grade of greater than <code>550</code>, we could do the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a>PISA_2018 <span class="sc">%&gt;%</span></span>
<span id="cb57-2"><a href="#cb57-2"></a>  <span class="fu">mutate</span>(<span class="at">PV1READ_high =</span> PV1READ <span class="sc">&gt;</span> <span class="dv">550</span>) <span class="sc">%&gt;%</span></span>
<span id="cb57-3"><a href="#cb57-3"></a>  <span class="fu">group_by</span>(CNT, PV1READ_high) <span class="sc">%&gt;%</span></span>
<span id="cb57-4"><a href="#cb57-4"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 159 × 3
# Groups:   CNT [80]
   CNT                  PV1READ_high     n
   &lt;fct&gt;                &lt;lgl&gt;        &lt;int&gt;
 1 Albania              FALSE         6083
 2 Albania              TRUE           276
 3 United Arab Emirates FALSE        16567
 4 United Arab Emirates TRUE          2710
 5 Argentina            FALSE        11003
 6 Argentina            TRUE           972
 7 Australia            FALSE         9311
 8 Australia            TRUE          4962
 9 Austria              FALSE         4900
10 Austria              TRUE          1902
# ℹ 149 more rows</code></pre>
</div>
</div>
<p>Comparisons can also be made between different columns, if we wanted to find out the percentage of Males and Females that got a better grade in their maths test <code>PV1MATH</code> than in their reading test <code>PV1READ</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1"></a>PISA_2018 <span class="sc">%&gt;%</span></span>
<span id="cb59-2"><a href="#cb59-2"></a>  <span class="fu">mutate</span>(<span class="at">maths_better =</span> PV1MATH <span class="sc">&gt;</span> PV1READ) <span class="sc">%&gt;%</span></span>
<span id="cb59-3"><a href="#cb59-3"></a>  <span class="fu">select</span>(CNT, ST004D01T, maths_better, PV1MATH, PV1READ) <span class="sc">%&gt;%</span> </span>
<span id="cb59-4"><a href="#cb59-4"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST004D01T), <span class="sc">!</span><span class="fu">is.na</span>(maths_better)) <span class="sc">%&gt;%</span></span>
<span id="cb59-5"><a href="#cb59-5"></a>  <span class="fu">group_by</span>(ST004D01T) <span class="sc">%&gt;%</span></span>
<span id="cb59-6"><a href="#cb59-6"></a>  <span class="fu">mutate</span>(<span class="at">students_n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb59-7"><a href="#cb59-7"></a>  <span class="fu">group_by</span>(ST004D01T, maths_better) <span class="sc">%&gt;%</span></span>
<span id="cb59-8"><a href="#cb59-8"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb59-9"><a href="#cb59-9"></a>            <span class="at">per =</span> n<span class="sc">/</span><span class="fu">unique</span>(students_n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 4
# Groups:   ST004D01T [2]
  ST004D01T maths_better      n   per
  &lt;fct&gt;     &lt;lgl&gt;         &lt;int&gt; &lt;dbl&gt;
1 Female    FALSE        176021 0.583
2 Female    TRUE         126157 0.417
3 Male      FALSE        110269 0.362
4 Male      TRUE         194178 0.638</code></pre>
</div>
</div>
<ul>
<li>line 2 <code>mutate</code> creates a new field called <code>maths_better</code> made up by comparing the <code>PV1MATH</code> grade with <code>PV1READ</code> and creating a boolean/logical vector for the column.</li>
<li>line 3 <code>select</code>s a subset of the columns</li>
<li>line 4 <code>filter</code>s out any students that don’t have gender data <code>ST004D01T</code>, or where the calculation on line 2 failed, i.e.&nbsp;<code>PV1MATH</code> or <code>PV1READ</code> was <code>NA</code>
</li>
<li>line 5 <code>group</code> on the gender of the student</li>
<li>line 6 using the <code>group</code> on line 5, use <code>mutate</code> to calculate the total number of Males and Females by looking for the number of rows in each group <code>n()</code>, store this as <code>students_n</code>
</li>
<li>line 7 re-<code>group</code> the data on gender <code>ST004D01T</code> and whether the student is better at maths than reading <code>maths_better</code>
</li>
<li>line 8 count the number of students, <code>n</code> in each group, as specified by line 7.</li>
<li>line 9 create a percentage figure for the number of students in each grouping given by line 7. Use the <code>n</code> value from line 8 and the <code>students_n</code> value from line 6. <strong>NOTE:</strong> we need to use <code>unique(students_n)</code> to return just one value for each grouping rather than a value for every row of the line 7 grouping</li>
</ul>
<p>For more information on how to <code>mutate</code> fields using <code>ifelse</code>, see <a href="#sec-ifelse">Section&nbsp;8.1</a></p>
</section><section id="arrange" class="level1" data-number="6"><h1 data-number="6">
<span class="header-section-number">6</span> arrange</h1>
<p>The results returned by pipes can be huge, so it’s a good idea to store them in objects and explore them in the Environment window where you can sort and search within the output. There might also be times when you want to order/<code>arrange</code> the outputs in a particular way. We can do this quite easily in the tidyverse by using the <code>arrange(&lt;column_name&gt;, &lt;column_name&gt;)</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1"></a>PISA_2018 <span class="sc">%&gt;%</span></span>
<span id="cb61-2"><a href="#cb61-2"></a>  <span class="fu">select</span>(CNT, ST004D01T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb61-3"><a href="#cb61-3"></a>  <span class="fu">arrange</span>(PV1MATH)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 612,004 × 3
   CNT             ST004D01T PV1MATH
   &lt;fct&gt;           &lt;fct&gt;       &lt;dbl&gt;
 1 Philippines     Female       24.7
 2 Jordan          Male         51.0
 3 Jordan          Female       61.6
 4 Mexico          Female       64.3
 5 Kazakhstan      Male         70.4
 6 Jordan          Male         70.7
 7 Bulgaria        Male         73.4
 8 Kosovo          Male         76.0
 9 North Macedonia Female       78.3
10 North Macedonia Male         81.2
# ℹ 611,994 more rows</code></pre>
</div>
</div>
<p>If we’re interested in the highest achieving students we can add the <code>desc()</code> function to <code>arrange</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1"></a>PISA_2018 <span class="sc">%&gt;%</span></span>
<span id="cb63-2"><a href="#cb63-2"></a>  <span class="fu">select</span>(CNT, LANGN, ST004D01T, PV1MATH) <span class="sc">%&gt;%</span></span>
<span id="cb63-3"><a href="#cb63-3"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(PV1MATH))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 612,004 × 4
   CNT                  LANGN                  ST004D01T PV1MATH
   &lt;fct&gt;                &lt;fct&gt;                  &lt;fct&gt;       &lt;dbl&gt;
 1 Canada               Another language (CAN) Male         888.
 2 Canada               Another language (CAN) Male         874.
 3 United Arab Emirates English                Male         865.
 4 B-S-J-Z (China)      Mandarin               Female       864.
 5 Australia            English                Male         863.
 6 B-S-J-Z (China)      Mandarin               Male         861.
 7 Serbia               Serbian                Male         860.
 8 Singapore            Invalid                Female       849.
 9 Australia            Cantonese              Male         845.
10 Canada               French                 Female       842.
# ℹ 611,994 more rows</code></pre>
</div>
</div>
</section><section id="bring-everyting-together" class="level1" data-number="7"><h1 data-number="7">
<span class="header-section-number">7</span> Bring everyting together</h1>
<p>We know that the <a href="https://educationendowmentfoundation.org.uk/education-evidence/teaching-learning-toolkit/repeating-a-year">evidence</a> strongly indicates that repeating a year is not good for student progress, but how do countries around the world differ in terms of the percentage of their students who repeat a year?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1"></a>data_repeat <span class="ot">&lt;-</span> PISA_2018 <span class="sc">%&gt;%</span></span>
<span id="cb65-2"><a href="#cb65-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(REPEAT)) <span class="sc">%&gt;%</span></span>
<span id="cb65-3"><a href="#cb65-3"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb65-4"><a href="#cb65-4"></a>  <span class="fu">mutate</span>(<span class="at">total =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb65-5"><a href="#cb65-5"></a>  <span class="fu">select</span>(CNT, REPEAT, total) <span class="sc">%&gt;%</span></span>
<span id="cb65-6"><a href="#cb65-6"></a>  <span class="fu">group_by</span>(CNT, REPEAT) <span class="sc">%&gt;%</span></span>
<span id="cb65-7"><a href="#cb65-7"></a>  <span class="fu">summarise</span>(<span class="at">student_n =</span> <span class="fu">n</span>(),</span>
<span id="cb65-8"><a href="#cb65-8"></a>            <span class="at">total =</span> <span class="fu">unique</span>(total),</span>
<span id="cb65-9"><a href="#cb65-9"></a>            <span class="at">per =</span> student_n <span class="sc">/</span> <span class="fu">unique</span>(total)) <span class="sc">%&gt;%</span></span>
<span id="cb65-10"><a href="#cb65-10"></a>  <span class="fu">filter</span>(REPEAT <span class="sc">==</span> <span class="st">"Repeated a  grade"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb65-11"><a href="#cb65-11"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(per))</span>
<span id="cb65-12"><a href="#cb65-12"></a></span>
<span id="cb65-13"><a href="#cb65-13"></a><span class="fu">print</span>(data_repeat)</span>
<span id="cb65-14"><a href="#cb65-14"></a></span>
<span id="cb65-15"><a href="#cb65-15"></a><span class="fu">write_csv</span>(data_repeat, <span class="st">"&lt;folder_location&gt;/repeat_a_year.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 77 × 5
# Groups:   CNT [77]
   CNT                REPEAT            student_n total   per
   &lt;fct&gt;              &lt;fct&gt;                 &lt;int&gt; &lt;int&gt; &lt;dbl&gt;
 1 Morocco            Repeated a  grade      3333  6666 0.5  
 2 Colombia           Repeated a  grade      2746  7185 0.382
 3 Lebanon            Repeated a  grade      1580  4756 0.332
 4 Uruguay            Repeated a  grade      1657  5049 0.328
 5 Luxembourg         Repeated a  grade      1655  5168 0.320
 6 Dominican Republic Repeated a  grade      1694  5474 0.309
 7 Brazil             Repeated a  grade      3227 10438 0.309
 8 Macao              Repeated a  grade      1135  3773 0.301
 9 Belgium            Repeated a  grade      2351  8089 0.291
10 Costa Rica         Repeated a  grade      1904  6571 0.290
# ℹ 67 more rows</code></pre>
</div>
</div>
<ul>
<li>Line 2, <code>filter</code> out any <code>NA</code> values in the <code>REPEAT</code> field</li>
<li>Line 3, group on the country of student <code>CNT</code>
</li>
<li>Line 4, create a new column <code>total</code> for total number of rows <code>n()</code> in each country <code>CNT</code> grouping</li>
<li>Line 5, select on the <code>CNT</code>, <code>REPEAT</code> and <code>total</code> columns</li>
<li>Line 6, regroup the data on country <code>CNT</code> and whether a student has repeated a year <code>REPEAT</code>, i.e.&nbsp;Albania+Did not repeat a grade; Albania+Repeated a grade; etc.</li>
<li>Line 7, using the above grouping, count the number of rows in each group <code>n()</code> and assign this to <code>student_n</code>
</li>
<li>Line 8, for each grouping keep the <code>total</code> number of students in each country, as calculated on line 4. Note: <code>unique(total)</code> is needed here to return a single value of <code>total</code>, rather than a value for each student in each country</li>
<li>Line 9, using <code>student_n</code> from line 7 and the number of students per country <code>total</code>, from line 4, create a percentage <code>per</code> for each grouping</li>
<li>Line 10, as we have percentages for both <code>Repeated a  grade</code> and <code>Did not repeat a  grade</code>, we only need to display one of these. Note: that there is an extra space in this</li>
<li>Line 11, finally, we sort the data on the per/percentage column, to show the countries with the highest level of repeating a grade. This data is self-recorded by students, so might not be totally reliable!</li>
<li>Line 15, save the data to your own folder as a csv</li>
</ul></section><section id="advanced-topics" class="level1" data-number="8"><h1 data-number="8">
<span class="header-section-number">8</span> Advanced topics</h1>
<section id="sec-ifelse" class="level2" data-number="8.1"><h2 data-number="8.1" class="anchored" data-anchor-id="sec-ifelse">
<span class="header-section-number">8.1</span> Recoding data (ifelse)</h2>
<p>Often we want to plot values in groupings that don’t yet exist, for example might want to give all schools over a certain size a different <em>colour</em> from others schools, or flag up students who have a different home language to the language that is being taught in school. To do this we need to look at how we can <em>recode</em> values. A common way to recode values is through an <code>ifelse</code> statement:</p>
<blockquote class="blockquote">
<p><code>ifelse(&lt;statement(s)&gt;, &lt;value_if_true&gt;, &lt;value_if_false&gt;)</code></p>
</blockquote>
<p><code>ifelse</code> allows us to <em>recode</em> the data. In the example below, we are going to add a new column to the <code>PISA_2018</code> dataset (using <code>mutate</code>) noting whether a student got a higher grade in their Maths <code>PV1MATH</code> or Reading <code>PV1READ</code> tests. <strong>if</strong> <code>PV1MATH</code> is bigger then <code>PV1READ</code>, the <code>maths_better</code> is <code>TRUE</code>, <strong>else</strong> <code>maths_better</code> is <code>FALSE</code>, or in <code>dplyr</code> format:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1"></a>maths_data <span class="ot">&lt;-</span> PISA_2018 <span class="sc">%&gt;%</span></span>
<span id="cb67-2"><a href="#cb67-2"></a>  <span class="fu">mutate</span>(<span class="at">maths_better =</span> </span>
<span id="cb67-3"><a href="#cb67-3"></a>           <span class="fu">ifelse</span>(PV1MATH <span class="sc">&gt;</span> PV1READ,</span>
<span id="cb67-4"><a href="#cb67-4"></a>                  <span class="cn">TRUE</span>, </span>
<span id="cb67-5"><a href="#cb67-5"></a>                  <span class="cn">FALSE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb67-6"><a href="#cb67-6"></a>  <span class="fu">select</span>(CNT, ST004D01T, maths_better, PV1MATH, PV1READ)</span>
<span id="cb67-7"><a href="#cb67-7"></a></span>
<span id="cb67-8"><a href="#cb67-8"></a><span class="fu">print</span>(maths_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 612,004 × 5
   CNT     ST004D01T maths_better PV1MATH PV1READ
   &lt;fct&gt;   &lt;fct&gt;     &lt;lgl&gt;          &lt;dbl&gt;   &lt;dbl&gt;
 1 Albania Male      TRUE            490.    376.
 2 Albania Male      TRUE            462.    434.
 3 Albania Female    TRUE            407.    359.
 4 Albania Male      TRUE            483.    425.
 5 Albania Male      TRUE            460.    306.
 6 Albania Female    TRUE            367.    352.
 7 Albania Female    FALSE           411.    413.
 8 Albania Male      TRUE            441.    271.
 9 Albania Female    TRUE            506.    373.
10 Albania Female    FALSE           412.    412.
# ℹ 611,994 more rows</code></pre>
</div>
</div>
<p>We now take this new dataset <code>maths_data</code> and look at whether the difference between relative performance in maths and reading is the same for girls and boys:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1"></a>maths_data <span class="sc">%&gt;%</span> </span>
<span id="cb69-2"><a href="#cb69-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST004D01T), <span class="sc">!</span><span class="fu">is.na</span>(maths_better)) <span class="sc">%&gt;%</span></span>
<span id="cb69-3"><a href="#cb69-3"></a>  <span class="fu">group_by</span>(ST004D01T, maths_better) <span class="sc">%&gt;%</span></span>
<span id="cb69-4"><a href="#cb69-4"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
# Groups:   ST004D01T [2]
  ST004D01T maths_better      n
  &lt;fct&gt;     &lt;lgl&gt;         &lt;int&gt;
1 Female    FALSE        176021
2 Female    TRUE         126157
3 Male      FALSE        110269
4 Male      TRUE         194178</code></pre>
</div>
</div>
<div class="question">
<p>Adjust the code above to work out the percentages of Males and Females <code>ST004D01T</code> in each group. Check to see if the pattern also exists between science <code>PV1SCIE</code> and reading <code>PV1READ</code>:</p>
<div class="cell">
<details><summary>adding percentage column</summary><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1"></a>PISA_2018 <span class="sc">%&gt;%</span></span>
<span id="cb71-2"><a href="#cb71-2"></a>  <span class="fu">mutate</span>(<span class="at">maths_better =</span> </span>
<span id="cb71-3"><a href="#cb71-3"></a>           <span class="fu">ifelse</span>(PV1MATH <span class="sc">&gt;</span> PV1READ,</span>
<span id="cb71-4"><a href="#cb71-4"></a>                  <span class="cn">TRUE</span>, </span>
<span id="cb71-5"><a href="#cb71-5"></a>                  <span class="cn">FALSE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb71-6"><a href="#cb71-6"></a>  <span class="fu">select</span>(CNT, ST004D01T, maths_better, PV1MATH, PV1READ) <span class="sc">%&gt;%</span> </span>
<span id="cb71-7"><a href="#cb71-7"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST004D01T), <span class="sc">!</span><span class="fu">is.na</span>(maths_better)) <span class="sc">%&gt;%</span></span>
<span id="cb71-8"><a href="#cb71-8"></a>  <span class="fu">group_by</span>(ST004D01T) <span class="sc">%&gt;%</span></span>
<span id="cb71-9"><a href="#cb71-9"></a>  <span class="fu">mutate</span>(<span class="at">students_n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb71-10"><a href="#cb71-10"></a>  <span class="fu">group_by</span>(ST004D01T, maths_better) <span class="sc">%&gt;%</span></span>
<span id="cb71-11"><a href="#cb71-11"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb71-12"><a href="#cb71-12"></a>            <span class="at">per =</span> n<span class="sc">/</span><span class="fu">unique</span>(students_n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details><summary>comparing science and reading</summary><div class="sourceCode cell-code" id="cb72"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1"></a>PISA_2018 <span class="sc">%&gt;%</span></span>
<span id="cb72-2"><a href="#cb72-2"></a>  <span class="fu">mutate</span>(<span class="at">sci_better =</span> </span>
<span id="cb72-3"><a href="#cb72-3"></a>           <span class="fu">ifelse</span>(PV1SCIE <span class="sc">&gt;</span> PV1READ,</span>
<span id="cb72-4"><a href="#cb72-4"></a>                  <span class="cn">TRUE</span>, </span>
<span id="cb72-5"><a href="#cb72-5"></a>                  <span class="cn">FALSE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb72-6"><a href="#cb72-6"></a>  <span class="fu">select</span>(CNT, ST004D01T, sci_better, PV1SCIE, PV1READ) <span class="sc">%&gt;%</span> </span>
<span id="cb72-7"><a href="#cb72-7"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST004D01T), <span class="sc">!</span><span class="fu">is.na</span>(sci_better)) <span class="sc">%&gt;%</span></span>
<span id="cb72-8"><a href="#cb72-8"></a>  <span class="fu">group_by</span>(ST004D01T) <span class="sc">%&gt;%</span></span>
<span id="cb72-9"><a href="#cb72-9"></a>  <span class="fu">mutate</span>(<span class="at">students_n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb72-10"><a href="#cb72-10"></a>  <span class="fu">group_by</span>(ST004D01T, sci_better) <span class="sc">%&gt;%</span></span>
<span id="cb72-11"><a href="#cb72-11"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb72-12"><a href="#cb72-12"></a>            <span class="at">per =</span> n<span class="sc">/</span><span class="fu">unique</span>(students_n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details><summary>comparing science and maths</summary><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1"></a>PISA_2018 <span class="sc">%&gt;%</span></span>
<span id="cb73-2"><a href="#cb73-2"></a>  <span class="fu">mutate</span>(<span class="at">sci_better =</span> </span>
<span id="cb73-3"><a href="#cb73-3"></a>           <span class="fu">ifelse</span>(PV1SCIE <span class="sc">&gt;</span> PV1MATH,</span>
<span id="cb73-4"><a href="#cb73-4"></a>                  <span class="cn">TRUE</span>, </span>
<span id="cb73-5"><a href="#cb73-5"></a>                  <span class="cn">FALSE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb73-6"><a href="#cb73-6"></a>  <span class="fu">select</span>(CNT, ST004D01T, sci_better, PV1SCIE, PV1MATH) <span class="sc">%&gt;%</span> </span>
<span id="cb73-7"><a href="#cb73-7"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ST004D01T), <span class="sc">!</span><span class="fu">is.na</span>(sci_better)) <span class="sc">%&gt;%</span></span>
<span id="cb73-8"><a href="#cb73-8"></a>  <span class="fu">group_by</span>(ST004D01T) <span class="sc">%&gt;%</span></span>
<span id="cb73-9"><a href="#cb73-9"></a>  <span class="fu">mutate</span>(<span class="at">students_n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb73-10"><a href="#cb73-10"></a>  <span class="fu">group_by</span>(ST004D01T, sci_better) <span class="sc">%&gt;%</span></span>
<span id="cb73-11"><a href="#cb73-11"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb73-12"><a href="#cb73-12"></a>            <span class="at">per =</span> n<span class="sc">/</span><span class="fu">unique</span>(students_n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<p><code>ifelse</code> statements can get a little complicated when using factors (see: <a href="#sec-factors">Section&nbsp;8.2</a>). Take this example. Let’s flag students who have a different home language <code>LANGN</code> to the language that is being used in the PISA assessment tool <code>LANGTEST_QQQ</code>. We make an assumption here that the assessment tool will be the language used at school, so these students will be learning in a different language to their mother tongue. <strong>if</strong> <code>LANGN</code> equals <code>LANGTEST_QQQ</code>, the <code>lang_diff</code> is <code>FALSE</code>, <strong>else</strong> <code>lang_diff</code> is <code>TRUE</code>, this raises an error:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1"></a>lang_data <span class="ot">&lt;-</span> PISA_2018 <span class="sc">%&gt;%</span></span>
<span id="cb74-2"><a href="#cb74-2"></a>  <span class="fu">mutate</span>(<span class="at">lang_diff =</span> </span>
<span id="cb74-3"><a href="#cb74-3"></a>           <span class="fu">ifelse</span>(LANGN <span class="sc">==</span> LANGTEST_QQQ,</span>
<span id="cb74-4"><a href="#cb74-4"></a>                  <span class="cn">FALSE</span>, </span>
<span id="cb74-5"><a href="#cb74-5"></a>                  <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb74-6"><a href="#cb74-6"></a>  <span class="fu">select</span>(CNT, lang_diff, LANGTEST_QQQ, LANGN)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in `mutate()`:
ℹ In argument: `lang_diff = ifelse(LANGN == LANGTEST_QQQ, FALSE, TRUE)`.
Caused by error in `Ops.factor()`:
! level sets of factors are different</code></pre>
</div>
</div>
<p>The levels in each field are different, i.e.&nbsp;the range of home languages is larger than the range of test languages. To fix this, all we need to do is cast the factors <code>LANGN</code> and <code>LANGTEST_QQQ</code> as characters using <code>as.character(&lt;field&gt;)</code>. This will then allow the comparison of the text stored in each row:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1"></a>lang_data <span class="ot">&lt;-</span> PISA_2018 <span class="sc">%&gt;%</span></span>
<span id="cb76-2"><a href="#cb76-2"></a>  <span class="fu">mutate</span>(<span class="at">lang_diff =</span> </span>
<span id="cb76-3"><a href="#cb76-3"></a>           <span class="fu">ifelse</span>(<span class="fu">as.character</span>(LANGN) <span class="sc">==</span> <span class="fu">as.character</span>(LANGTEST_QQQ),</span>
<span id="cb76-4"><a href="#cb76-4"></a>                  <span class="cn">FALSE</span>, </span>
<span id="cb76-5"><a href="#cb76-5"></a>                  <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb76-6"><a href="#cb76-6"></a>  <span class="fu">select</span>(CNT, lang_diff, LANGTEST_QQQ, LANGN)</span>
<span id="cb76-7"><a href="#cb76-7"></a></span>
<span id="cb76-8"><a href="#cb76-8"></a><span class="fu">print</span>(lang_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 612,004 × 4
   CNT     lang_diff LANGTEST_QQQ LANGN                 
   &lt;fct&gt;   &lt;lgl&gt;     &lt;fct&gt;        &lt;fct&gt;                 
 1 Albania TRUE      Albanian     Another language (ALB)
 2 Albania FALSE     Albanian     Albanian              
 3 Albania FALSE     Albanian     Albanian              
 4 Albania FALSE     Albanian     Albanian              
 5 Albania FALSE     Albanian     Albanian              
 6 Albania FALSE     Albanian     Albanian              
 7 Albania NA        &lt;NA&gt;         Missing               
 8 Albania FALSE     Albanian     Albanian              
 9 Albania FALSE     Albanian     Albanian              
10 Albania NA        &lt;NA&gt;         Missing               
# ℹ 611,994 more rows</code></pre>
</div>
</div>
<p>We can now look at this dataset to get an idea of which countries have the largest percentage of students learning in a language other than their mother tongue:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1"></a>lang_data_diff <span class="ot">&lt;-</span> lang_data <span class="sc">%&gt;%</span> </span>
<span id="cb78-2"><a href="#cb78-2"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb78-3"><a href="#cb78-3"></a>  <span class="fu">mutate</span>(<span class="at">student_n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb78-4"><a href="#cb78-4"></a>  <span class="fu">group_by</span>(CNT, lang_diff) <span class="sc">%&gt;%</span></span>
<span id="cb78-5"><a href="#cb78-5"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb78-6"><a href="#cb78-6"></a>            <span class="at">percentage =</span> <span class="dv">100</span><span class="sc">*</span>(n <span class="sc">/</span> <span class="fu">max</span>(student_n))) <span class="sc">%&gt;%</span></span>
<span id="cb78-7"><a href="#cb78-7"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(lang_diff),</span>
<span id="cb78-8"><a href="#cb78-8"></a>         lang_diff <span class="sc">==</span> <span class="cn">TRUE</span>)</span>
<span id="cb78-9"><a href="#cb78-9"></a></span>
<span id="cb78-10"><a href="#cb78-10"></a><span class="fu">print</span>(lang_data_diff)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 80 × 4
# Groups:   CNT [80]
   CNT                    lang_diff     n percentage
   &lt;fct&gt;                  &lt;lgl&gt;     &lt;int&gt;      &lt;dbl&gt;
 1 Albania                TRUE        284       4.47
 2 United Arab Emirates   TRUE       8195      42.5 
 3 Argentina              TRUE        651       5.44
 4 Australia              TRUE       2238      15.7 
 5 Austria                TRUE       1329      19.5 
 6 Belgium                TRUE       2458      29.0 
 7 Bulgaria               TRUE        747      14.1 
 8 Bosnia and Herzegovina TRUE        526       8.12
 9 Belarus                TRUE        248       4.27
10 Brazil                 TRUE        297       2.78
# ℹ 70 more rows</code></pre>
</div>
</div>
<p>This looks like a promising dataset, but there are some strange results:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1"></a>lang_data_diff <span class="sc">%&gt;%</span> <span class="fu">filter</span>(percentage <span class="sc">&gt;</span> <span class="dv">92</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 4
# Groups:   CNT [9]
  CNT             lang_diff     n percentage
  &lt;fct&gt;           &lt;lgl&gt;     &lt;int&gt;      &lt;dbl&gt;
1 Hong Kong       TRUE       5880       97.4
2 Lebanon         TRUE       5339       95.1
3 Macao           TRUE       3683       97.6
4 Montenegro      TRUE       6411       96.2
5 Norway          TRUE       5813      100  
6 Philippines     TRUE       6823       94.3
7 B-S-J-Z (China) TRUE      12049       99.9
8 Singapore       TRUE       6666       99.9
9 Ukraine         TRUE       5597       93.3</code></pre>
</div>
</div>
<p>Exploring data for Ukraine, we can see that a different spelling has been used in each field, <em>Ukra</em><u>i</u>nian and <em>Ukranain</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1"></a>lang_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"Ukraine"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5,998 × 4
   CNT     lang_diff LANGTEST_QQQ LANGN    
   &lt;fct&gt;   &lt;lgl&gt;     &lt;fct&gt;        &lt;fct&gt;    
 1 Ukraine TRUE      Ukranian     Ukrainian
 2 Ukraine TRUE      Ukranian     Ukrainian
 3 Ukraine TRUE      Ukranian     Ukrainian
 4 Ukraine TRUE      Ukranian     Russian  
 5 Ukraine TRUE      Ukranian     Ukrainian
 6 Ukraine TRUE      Ukranian     Russian  
 7 Ukraine TRUE      Ukranian     Ukrainian
 8 Ukraine TRUE      Ukranian     Ukrainian
 9 Ukraine TRUE      Ukranian     Russian  
10 Ukraine TRUE      Ukranian     Ukrainian
# ℹ 5,988 more rows</code></pre>
</div>
</div>
<p><code>ifelse</code> can help here too. If we pick the spelling we want to stick to, we can <em>recode</em> fields to match:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1"></a>lang_data <span class="sc">%&gt;%</span> </span>
<span id="cb84-2"><a href="#cb84-2"></a>  <span class="fu">mutate</span>(<span class="at">LANGTEST_QQQ =</span> </span>
<span id="cb84-3"><a href="#cb84-3"></a>           <span class="fu">ifelse</span>(<span class="fu">as.character</span>(LANGTEST_QQQ) <span class="sc">==</span> <span class="st">"Ukranian"</span>,</span>
<span id="cb84-4"><a href="#cb84-4"></a>                 <span class="st">"Ukrainian"</span>,</span>
<span id="cb84-5"><a href="#cb84-5"></a>                 <span class="fu">as.character</span>(LANGTEST_QQQ))) <span class="sc">%&gt;%</span></span>
<span id="cb84-6"><a href="#cb84-6"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"Ukraine"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5,998 × 4
   CNT     lang_diff LANGTEST_QQQ LANGN    
   &lt;fct&gt;   &lt;lgl&gt;     &lt;chr&gt;        &lt;fct&gt;    
 1 Ukraine TRUE      Ukrainian    Ukrainian
 2 Ukraine TRUE      Ukrainian    Ukrainian
 3 Ukraine TRUE      Ukrainian    Ukrainian
 4 Ukraine TRUE      Ukrainian    Russian  
 5 Ukraine TRUE      Ukrainian    Ukrainian
 6 Ukraine TRUE      Ukrainian    Russian  
 7 Ukraine TRUE      Ukrainian    Ukrainian
 8 Ukraine TRUE      Ukrainian    Ukrainian
 9 Ukraine TRUE      Ukrainian    Russian  
10 Ukraine TRUE      Ukrainian    Ukrainian
# ℹ 5,988 more rows</code></pre>
</div>
</div>
<p>Unfortunately, if you explore this dataset a little further, the language fields are don’t conform well with each other and a lot more work with <code>ifelse</code> will be needed before you could put together any full analysis around students who speak different langages at home and at school.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>It’s possible to nest our <code>ifelse</code> statements, by writing another <code>ifelse</code> where you would have the <code>&lt;value_if_false&gt;</code>, for example we might want to give describe the type of school in England:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1"></a>plot_data <span class="ot">&lt;-</span> schools <span class="sc">%&gt;%</span> </span>
<span id="cb86-2"><a href="#cb86-2"></a>  <span class="fu">mutate</span>(<span class="at">sch_type =</span> </span>
<span id="cb86-3"><a href="#cb86-3"></a>           <span class="fu">ifelse</span>(EstablishmentGroup <span class="sc">==</span> <span class="st">"Special schools"</span>, <span class="st">"Special"</span>,</span>
<span id="cb86-4"><a href="#cb86-4"></a>                  <span class="fu">ifelse</span>(EstablishmentGroup <span class="sc">==</span> <span class="st">"Independent schools"</span>, <span class="st">"Independent"</span>,</span>
<span id="cb86-5"><a href="#cb86-5"></a>                         <span class="fu">ifelse</span>(AdmissionsPolicy<span class="sc">==</span><span class="st">"Selective"</span>, </span>
<span id="cb86-6"><a href="#cb86-6"></a>                                <span class="st">"Grammar"</span>, <span class="st">"Comprehensive"</span>))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section><section id="sec-factors" class="level2" data-number="8.2"><h2 data-number="8.2" class="anchored" data-anchor-id="sec-factors">
<span class="header-section-number">8.2</span> Factors and statistical data types</h2>
<p>The types of variable will heavily influence what statistical analysis you can perform. R is there to help by assigning datatypes to each field. We have different sorts of data that can be stored:</p>
<!-- https://www150.statcan.gc.ca/n1/edu/power-pouvoir/ch8/5214817-eng.htm -->
<ul>
<li>
<strong>Categorical</strong> - data that can be divided into groups or categories
<ul>
<li>
<strong>Nominal</strong> - categorical data where the order isn’t important, e.g.&nbsp;gender, or colours</li>
<li>
<strong>Ordinal</strong> - categorical data that may have order or ranking, e.g.&nbsp;exam grades (A, B, C, D) or lickert scales (strongly agree, agree, disgaree, strongly disagree)</li>
</ul>
</li>
<li>
<strong>Numeric</strong> - data that consists of numbers
<ul>
<li>
<strong>Continuous</strong> - numeric data that can take any value within a given range, e.g.&nbsp;height (178cm, 134.54cm)</li>
<li>
<strong>Discrete</strong> - numeric data that can take only certain values within a range, e.g.&nbsp;number of children in a family (0,1,2,3,4,5)</li>
</ul>
</li>
</ul>
<p>But here we are going to look at how R handles <code>factors</code>. Factors have two parts, <code>levels</code> and <code>codes</code>. levels are what you see when you view a table column, codes are an underlying order to the data. Factors allow you to store data that has a known set of values taht you might want to display in an order other than alphabetical. For example, if we look at the month field <code>ST003D02T</code> using the <code>levels(&lt;field&gt;)</code> command:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1"></a><span class="fu">levels</span>(PISA_2018<span class="sc">$</span>ST003D02T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "January"        "February"       "March"          "April"         
 [5] "May"            "June"           "July"           "August"        
 [9] "September"      "October"        "November"       "December"      
[13] "Valid Skip"     "Not Applicable" "Invalid"        "No Response"   </code></pre>
</div>
</div>
<p>We can see that the months of the year are there along with other possible <code>levels</code>. With this particular dataset, we have set all other levels as <code>NA</code>.</p>
<p><code>Codes</code> are the underlying numbers/order for each level, in this case <code>1 = January</code>, <code>2 = February</code>, etc.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1"></a><span class="fu">as.numeric</span>(PISA_2018<span class="sc">$</span>ST003D02T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  2  7  4  4  3  2  7  8  3  7 12  1 12  6  3
 [ reached getOption("max.print") -- omitted 611989 entries ]</code></pre>
</div>
</div>
<p>How can this be useful? A good example is how plots are made, they will use the <code>codes</code> to give an order to the display of columns, in the plot below, <code>February</code> (<code>2</code>) comes before <code>March</code> (<code>3</code>), even though there were more students born in <code>March</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1"></a>grph_data <span class="ot">&lt;-</span> PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb91-2"><a href="#cb91-2"></a>         <span class="fu">group_by</span>(ST003D02T) <span class="sc">%&gt;%</span> </span>
<span id="cb91-3"><a href="#cb91-3"></a>         <span class="fu">summarise</span>(<span class="at">n=</span><span class="fu">n</span>())</span>
<span id="cb91-4"><a href="#cb91-4"></a></span>
<span id="cb91-5"><a href="#cb91-5"></a><span class="fu">ggplot</span>(<span class="at">data=</span>grph_data, <span class="fu">aes</span>(<span class="at">x=</span>ST003D02T, <span class="at">y=</span>n)) <span class="sc">+</span> </span>
<span id="cb91-6"><a href="#cb91-6"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="02-3-Intro_to_analysis_software_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>To re-order the columns to match the number of students, we can either try to do this manually, which is rather cumbersome:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1"></a>my_levels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"July"</span>, <span class="st">"September"</span>, <span class="st">"January"</span>, <span class="st">"March"</span>, <span class="st">"February"</span>,<span class="st">"April"</span>,</span>
<span id="cb92-2"><a href="#cb92-2"></a>               <span class="st">"May"</span>, <span class="st">"June"</span>, <span class="st">"August"</span>, <span class="st">"October"</span>, <span class="st">"November"</span>, <span class="st">"December"</span>, </span>
<span id="cb92-3"><a href="#cb92-3"></a>               <span class="st">"Valid Skip"</span>, <span class="st">"Not Applicable"</span>, <span class="st">"Invalid"</span>, <span class="st">"No Response"</span>)</span>
<span id="cb92-4"><a href="#cb92-4"></a></span>
<span id="cb92-5"><a href="#cb92-5"></a>grph_data<span class="sc">$</span>ST003D02T <span class="ot">&lt;-</span> <span class="fu">factor</span>(grph_data<span class="sc">$</span>ST003D02T, <span class="at">levels=</span>my_levels)</span>
<span id="cb92-6"><a href="#cb92-6"></a></span>
<span id="cb92-7"><a href="#cb92-7"></a><span class="fu">ggplot</span>(<span class="at">data=</span>grph_data, <span class="fu">aes</span>(<span class="at">x=</span>ST003D02T, <span class="at">y=</span>n)) <span class="sc">+</span> </span>
<span id="cb92-8"><a href="#cb92-8"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="02-3-Intro_to_analysis_software_files/figure-html/unnamed-chunk-60-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Or get R to do this for us:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1"></a><span class="co"># get the levels in order and pull/create a vector of them</span></span>
<span id="cb93-2"><a href="#cb93-2"></a>my_levels <span class="ot">&lt;-</span> grph_data <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ST003D02T)</span>
<span id="cb93-3"><a href="#cb93-3"></a></span>
<span id="cb93-4"><a href="#cb93-4"></a><span class="co"># reassign the re-ordered levels to the dataframe column</span></span>
<span id="cb93-5"><a href="#cb93-5"></a>grph_data<span class="sc">$</span>ST003D02T <span class="ot">&lt;-</span> <span class="fu">factor</span>(grph_data<span class="sc">$</span>ST003D02T, <span class="at">levels=</span>my_levels)</span>
<span id="cb93-6"><a href="#cb93-6"></a></span>
<span id="cb93-7"><a href="#cb93-7"></a><span class="fu">ggplot</span>(<span class="at">data=</span>grph_data, <span class="fu">aes</span>(<span class="at">x=</span>ST003D02T, <span class="at">y=</span>n)) <span class="sc">+</span> </span>
<span id="cb93-8"><a href="#cb93-8"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="02-3-Intro_to_analysis_software_files/figure-html/unnamed-chunk-61-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>To learn a lot more about factors, see <a href="https://r4ds.had.co.nz/factors.html">Hadley’s chapter</a></p>
</section></section><section id="seminar-tasks" class="level1" data-number="9"><h1 data-number="9">
<span class="header-section-number">9</span> Seminar tasks</h1>
<section id="student-dataset" class="level2" data-number="9.1"><h2 data-number="9.1" class="anchored" data-anchor-id="student-dataset">
<span class="header-section-number">9.1</span> Student dataset</h2>
<div class="question">
<ol type="1">
<li>How many unique values are there in the <code>OCOD3</code> field for student intended future occupation? How does the most desired career vary by gender?</li>
</ol>
<div class="cell">
<details><summary>answer</summary><div class="sourceCode cell-code" id="cb94"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1"></a>PISA_2018<span class="sc">$</span>OCOD3 <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>()</span>
<span id="cb94-2"><a href="#cb94-2"></a></span>
<span id="cb94-3"><a href="#cb94-3"></a>PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb94-4"><a href="#cb94-4"></a>  <span class="fu">group_by</span>(ST004D01T, OCOD3) <span class="sc">%&gt;%</span></span>
<span id="cb94-5"><a href="#cb94-5"></a>  <span class="fu">summarise</span>(<span class="at">n =</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb94-6"><a href="#cb94-6"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>write code to work out the <code>mean</code> and <code>median</code> number of hours of learning Maths <code>MMINS</code> for each country <code>CNT</code>.</li>
</ol>
<div class="cell">
<details><summary>answer</summary><div class="sourceCode cell-code" id="cb95"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1"></a>PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb95-2"><a href="#cb95-2"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb95-3"><a href="#cb95-3"></a>  <span class="fu">summarise</span>(<span class="at">mean_MMINS =</span> <span class="fu">mean</span>(MMINS, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb95-4"><a href="#cb95-4"></a>            <span class="at">median_MMINS =</span> <span class="fu">median</span>(MMINS, <span class="at">na.rm=</span><span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb95-5"><a href="#cb95-5"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(median_MMINS))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="3" type="1">
<li>what is the fourth most popular language at home <code>LANGN</code> spoken by students in schools in the <code>United Kingdom</code>, how does this compare to <code>France</code>?</li>
</ol>
<div class="cell">
<details><summary>answer</summary><div class="sourceCode cell-code" id="cb96"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1"></a>PISA_2018 <span class="sc">%&gt;%</span> </span>
<span id="cb96-2"><a href="#cb96-2"></a>  <span class="fu">filter</span>(CNT <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"France"</span>, <span class="st">"United Kingdom"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb96-3"><a href="#cb96-3"></a>  <span class="fu">group_by</span>(CNT, LANGN) <span class="sc">%&gt;%</span></span>
<span id="cb96-4"><a href="#cb96-4"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb96-5"><a href="#cb96-5"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n))</span>
<span id="cb96-6"><a href="#cb96-6"></a></span>
<span id="cb96-7"><a href="#cb96-7"></a><span class="co"># a bit of a rubbish answer really, as France only codes this at French or varieties of Other</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="4" type="1">
<li>Spot the <strong>five</strong> errors with the following code. Can you make it work? What does it do?</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1"></a><span class="co"># Work out when more time spent in language lessons than maths lessons</span></span>
<span id="cb97-2"><a href="#cb97-2"></a>PISA_2018_lang <span class="sc">&lt;</span> PISA_2018 <span class="sc">%&gt;%</span></span>
<span id="cb97-3"><a href="#cb97-3"></a>  <span class="fu">rename</span>(<span class="at">gender =</span> ST004D01T) <span class="sc">%&gt;%</span></span>
<span id="cb97-4"><a href="#cb97-4"></a>  <span class="fu">mutate</span>(language <span class="at">importance =</span> LMINS <span class="sc">-</span> MMINS) <span class="sc">%&gt;%</span></span>
<span id="cb97-5"><a href="#cb97-5"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(language_importance)) <span class="sc">%&gt;%</span></span>
<span id="cb97-6"><a href="#cb97-6"></a>  <span class="fu">group_by</span>(CNT gender) <span class="sc">%&gt;%</span></span>
<span id="cb97-7"><a href="#cb97-7"></a>  <span class="fu">summarise</span>(<span class="at">students =</span> n,</span>
<span id="cb97-8"><a href="#cb97-8"></a>            <span class="at">lang_win =</span> <span class="fu">sum</span>(language_importance <span class="sc">&gt;=</span> <span class="dv">0</span>),</span>
<span id="cb97-9"><a href="#cb97-9"></a>            <span class="at">per_lang_win =</span> <span class="dv">100</span><span class="sc">*</span>(lang_win<span class="sc">/</span>students))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details><summary>answer</summary><div class="sourceCode cell-code" id="cb98"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1"></a><span class="co"># Work out when more time spent in language lessons than maths lessons</span></span>
<span id="cb98-2"><a href="#cb98-2"></a>PISA_2018_lang <span class="ot">&lt;-</span> PISA_2018 <span class="sc">%&gt;%</span>  <span class="co">#1 make sure you have the assignment arrow &lt;-</span></span>
<span id="cb98-3"><a href="#cb98-3"></a>  <span class="fu">rename</span>(<span class="at">gender =</span> ST004D01T) <span class="sc">%&gt;%</span></span>
<span id="cb98-4"><a href="#cb98-4"></a>  <span class="fu">mutate</span>(<span class="at">language_importance =</span> LMINS <span class="sc">-</span> MMINS) <span class="sc">%&gt;%</span> <span class="co">#2 _ not space in name of field</span></span>
<span id="cb98-5"><a href="#cb98-5"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(language_importance)) <span class="sc">%&gt;%</span>  <span class="co">#3 this needs to be !is.na, otherwise it'll return nothing</span></span>
<span id="cb98-6"><a href="#cb98-6"></a>  <span class="fu">group_by</span>(CNT, gender) <span class="sc">%&gt;%</span> <span class="co">#4 missing comma</span></span>
<span id="cb98-7"><a href="#cb98-7"></a>  <span class="fu">summarise</span>(<span class="at">students =</span> <span class="fu">n</span>(),   <span class="co">#5 missing brackets on the n() command</span></span>
<span id="cb98-8"><a href="#cb98-8"></a>            <span class="at">lang_win =</span> <span class="fu">sum</span>(language_importance <span class="sc">&gt;=</span> <span class="dv">0</span>),</span>
<span id="cb98-9"><a href="#cb98-9"></a>            <span class="at">per_lang_win =</span> <span class="dv">100</span><span class="sc">*</span>(lang_win<span class="sc">/</span>students))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="5" type="1">
<li>By gender work out the average attitudes to learning activities <code>ATTLNACT</code>
</li>
</ol>
</div>
</section><section id="teacher-dataset" class="level2" data-number="9.2"><h2 data-number="9.2" class="anchored" data-anchor-id="teacher-dataset">
<span class="header-section-number">9.2</span> Teacher dataset</h2>
<p>To further check your understanding of this section you will be attempting to analyse the 2018 teacher dataset. This dataset includes records for 107367 teachers from 19 countries, including 351 columns, covering attitudinal, demographic and workplace data. You can find the dataset <a href="https://drive.google.com/file/d/1ZKPV_CdUoLDaMP0atzf_Qwwu1ot6Uqor/view?usp=share_link">here</a> in the <code>.parquet</code> format.</p>
<div class="question">
<ol type="1">
<li>Work out how many teachers are in the dataset for the <code>United Kingdom</code>
</li>
</ol>
<div class="cell">
<details><summary>answer</summary><div class="sourceCode cell-code" id="cb99"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1"></a>PISA_2018_teacher <span class="sc">%&gt;%</span> </span>
<span id="cb99-2"><a href="#cb99-2"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb99-3"><a href="#cb99-3"></a>  <span class="fu">summarise</span>(<span class="at">n=</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb99-4"><a href="#cb99-4"></a>  <span class="fu">filter</span>(CNT <span class="sc">==</span> <span class="st">"United Kingdom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>For each country <code>CNT</code> by gender <code>TC001Q01NA</code>, what is the <code>mean</code> time that a teacher has been in the teaching profession <code>TC007Q02NA</code>? Include the number of teachers in each group. Order this to show the country with the longest serving workforce:</li>
</ol>
<div class="cell">
<details><summary>answer</summary><div class="sourceCode cell-code" id="cb100"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1"></a>PISA_2018_teacher <span class="sc">%&gt;%</span></span>
<span id="cb100-2"><a href="#cb100-2"></a>  <span class="fu">group_by</span>(CNT, TC001Q01NA) <span class="sc">%&gt;%</span></span>
<span id="cb100-3"><a href="#cb100-3"></a>  <span class="fu">summarise</span>(<span class="at">avg_years =</span> <span class="fu">mean</span>(TC007Q02NA, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb100-4"><a href="#cb100-4"></a>            <span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb100-5"><a href="#cb100-5"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(avg_years))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="3" type="1">
<li>For each country <code>CNT</code> find out which teachers provide the most opportunities for students to improve their critical thinking skills <code>TC207Q06HA</code>:</li>
</ol>
<div class="cell">
<details><summary>answer</summary><div class="sourceCode cell-code" id="cb101"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1"></a>PISA_2018_teacher <span class="sc">%&gt;%</span> </span>
<span id="cb101-2"><a href="#cb101-2"></a>  <span class="fu">rename</span>(<span class="at">crit_think =</span> TC207Q06HA) <span class="sc">%&gt;%</span></span>
<span id="cb101-3"><a href="#cb101-3"></a>  <span class="fu">group_by</span>(CNT) <span class="sc">%&gt;%</span></span>
<span id="cb101-4"><a href="#cb101-4"></a>  <span class="fu">mutate</span>(<span class="at">teachers=</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb101-5"><a href="#cb101-5"></a>  <span class="fu">group_by</span>(CNT, crit_think) <span class="sc">%&gt;%</span></span>
<span id="cb101-6"><a href="#cb101-6"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb101-7"><a href="#cb101-7"></a>            <span class="at">per =</span> <span class="fu">n</span>()<span class="sc">/</span><span class="fu">unique</span>(teachers)) <span class="sc">%&gt;%</span></span>
<span id="cb101-8"><a href="#cb101-8"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(per))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="4" type="1">
<li>Explore the data on use of technology in the classroom <code>TC169____</code>
</li>
</ol>
<div class="cell">
<details><summary>answer</summary><div class="sourceCode cell-code" id="cb102"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1"></a>PISA_2018_teacher <span class="sc">%&gt;%</span> <span class="fu">select</span>(CNT, TC001Q01NA, <span class="fu">starts_with</span>(<span class="st">"TC169"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="5" type="1">
<li><p>Save the results of one of the above questions using <code>write_csv()</code>.</p></li>
<li><p>[EXTENSION] explore the dataset and find out some more interesting facts to share with your group</p></li>
</ol>
</div>


</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>